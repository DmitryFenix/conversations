# Docker Compose для разработки с hot reload
# Использование: docker compose -f docker-compose.dev.yml up

services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./artifacts:/artifacts
      - ./mr_packages:/mr_packages
      - ./api/reviews.db:/app/reviews.db
      # Hot reload: монтируем исходники для автоматической перезагрузки
      - ./api/main.py:/app/main.py
      - ./api/eval_worker.py:/app/eval_worker.py
    # Hot reload: используем uvicorn с --reload
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - redis

  redis:
    image: redis:7.2-alpine
    ports:
      - "6379:6379"
    command: >
      sh -c "
      echo 1 > /proc/sys/vm/overcommit_memory 2>/dev/null || true &&
      redis-server --appendonly yes --save '' --maxmemory-policy noeviction
      "
    privileged: true
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 1s
      timeout: 3s
      retries: 30

  worker:
    build:
      context: .
      dockerfile: api/Dockerfile
    command: [ "rq", "worker", "default" ]
    volumes:
      - ./artifacts:/artifacts
      - ./mr_packages:/mr_packages
      # Hot reload для worker (если нужно)
      - ./api/eval_worker.py:/app/eval_worker.py
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - RQ_REDIS_URL=redis://redis:6379
      - PYTHONUNBUFFERED=1

  # Dev-сервер для фронтенда (опционально)
  frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://api:8000
    command: npm run dev -- --host 0.0.0.0
    depends_on:
      - api

