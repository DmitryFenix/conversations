# План реализации системы Merge Requests для тестирования навыков

## 1. Выбор СУБД для хранения Merge Requests

### Анализ требований:
- **Объём данных**: Merge Requests могут содержать:
  - Метаданные (автор, дата, статус, описание)
  - Diff (может быть большим, до нескольких MB)
  - Комментарии и обсуждения
  - Файлы изменений
  - Метрики и статистика

- **Требования к производительности**:
  - Быстрый поиск по метрикам
  - Фильтрация по сложности, языку, типу изменений
  - Поддержка полнотекстового поиска

- **Масштабируемость**:
  - Начально: 50-200 MR
  - Потенциально: до 1000+ MR

### Рекомендация: **PostgreSQL**

**Преимущества:**
1. ✅ Поддержка JSON/JSONB для хранения diff и метаданных
2. ✅ Полнотекстовый поиск (tsvector/tsquery)
3. ✅ Индексы GIN для быстрого поиска по JSON
4. ✅ Поддержка больших объектов (TOAST)
5. ✅ Расширяемость (можно добавить расширения)
6. ✅ ACID транзакции
7. ✅ Хорошая интеграция с Python (psycopg2, SQLAlchemy)

**Альтернативы:**
- **SQLite** (текущая БД) - подходит для MVP, но ограничения:
  - Нет полноценного JSON индексирования
  - Ограничения на размер файла
  - Медленнее при больших объёмах
  
- **MongoDB** - избыточно для структурированных данных

### Решение: **PostgreSQL** для production, **SQLite** для разработки

---

## 2. Метрики для выбора Merge Requests

### Критерии оценки MR для тестирования навыков ревью:

#### 2.1. Технические метрики:

1. **Сложность кода (Complexity)**
   - Цикломатическая сложность изменений
   - Количество изменённых файлов
   - Размер diff (строки добавлены/удалены)
   - Глубина вложенности

2. **Тип изменений (Change Type)**
   - Bug fix
   - Feature addition
   - Refactoring
   - Performance optimization
   - Security fix
   - Documentation

3. **Язык программирования (Language)**
   - Python
   - JavaScript/TypeScript
   - Java
   - Go
   - C/C++
   - И другие

4. **Качество кода (Code Quality)**
   - Наличие тестов
   - Покрытие тестами
   - Соответствие стандартам кодирования
   - Наличие code smells

5. **Архитектурные аспекты (Architecture)**
   - Изменения в архитектуре
   - Паттерны проектирования
   - SOLID принципы
   - Зависимости

#### 2.2. Метрики для оценки навыков ревьюера:

1. **Обнаружение проблем (Issue Detection)**
   - Количество реальных багов в MR
   - Количество потенциальных проблем
   - Типы проблем (security, performance, maintainability)

2. **Качество комментариев (Comment Quality)**
   - Наличие конструктивных комментариев в оригинальном MR
   - Предложения по улучшению
   - Объяснение проблем

3. **Сложность для ревью (Review Difficulty)**
   - Время на ревью (оценка)
   - Количество вопросов в оригинальном ревью
   - Количество итераций

#### 2.3. Классификация MR по уровням:

**Beginner (Начальный)**
- Простые изменения (1-3 файла)
- Небольшой diff (< 100 строк)
- Очевидные проблемы
- Один язык программирования

**Intermediate (Средний)**
- Средние изменения (3-10 файлов)
- Средний diff (100-500 строк)
- Скрытые проблемы
- Возможно несколько языков

**Advanced (Продвинутый)**
- Сложные изменения (10+ файлов)
- Большой diff (500+ строк)
- Архитектурные проблемы
- Множество языков/технологий

---

## 3. Структура базы данных

### Таблица: `merge_requests`

```sql
CREATE TABLE merge_requests (
    id SERIAL PRIMARY KEY,
    
    -- Идентификация
    external_id TEXT UNIQUE,  -- ID из исходной системы (GitHub, GitLab, etc.)
    title TEXT NOT NULL,
    description TEXT,
    url TEXT,  -- Ссылка на оригинальный MR
    
    -- Метаданные
    author TEXT,
    created_at TIMESTAMP,
    merged_at TIMESTAMP,
    state TEXT,  -- 'open', 'merged', 'closed'
    
    -- Технические характеристики
    language TEXT,  -- Основной язык
    languages TEXT[],  -- Массив языков (если несколько)
    change_type TEXT,  -- 'bugfix', 'feature', 'refactoring', etc.
    
    -- Метрики сложности
    files_changed INTEGER,
    lines_added INTEGER,
    lines_deleted INTEGER,
    diff_size INTEGER,  -- Размер diff в байтах
    complexity_score REAL,  -- Оценка сложности (0-100)
    
    -- Diff и содержимое
    diff_content TEXT,  -- Полный diff (может быть большим)
    diff_path TEXT,  -- Путь к файлу diff (если храним отдельно)
    
    -- Метрики качества
    has_tests BOOLEAN DEFAULT FALSE,
    test_coverage REAL,  -- Покрытие тестами (0-100)
    code_quality_score REAL,  -- Оценка качества кода
    
    -- Проблемы и баги
    bugs_count INTEGER DEFAULT 0,  -- Количество реальных багов
    issues_detected TEXT[],  -- Массив обнаруженных проблем
    security_issues INTEGER DEFAULT 0,
    performance_issues INTEGER DEFAULT 0,
    
    -- Классификация
    difficulty_level TEXT,  -- 'beginner', 'intermediate', 'advanced'
    review_time_estimate INTEGER,  -- Оценка времени на ревью (минуты)
    
    -- Дополнительные данные
    metadata JSONB,  -- Дополнительные метаданные
    tags TEXT[],  -- Теги для категоризации
    
    -- Временные метки
    created_at_db TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Индексы для быстрого поиска
CREATE INDEX idx_mr_language ON merge_requests(language);
CREATE INDEX idx_mr_difficulty ON merge_requests(difficulty_level);
CREATE INDEX idx_mr_change_type ON merge_requests(change_type);
CREATE INDEX idx_mr_complexity ON merge_requests(complexity_score);
CREATE INDEX idx_mr_tags ON merge_requests USING GIN(tags);
CREATE INDEX idx_mr_metadata ON merge_requests USING GIN(metadata);
CREATE INDEX idx_mr_created_at ON merge_requests(created_at);

-- Полнотекстовый поиск
CREATE INDEX idx_mr_search ON merge_requests USING GIN(
    to_tsvector('english', coalesce(title, '') || ' ' || coalesce(description, ''))
);
```

### Таблица: `mr_files` (для детализации по файлам)

```sql
CREATE TABLE mr_files (
    id SERIAL PRIMARY KEY,
    mr_id INTEGER REFERENCES merge_requests(id) ON DELETE CASCADE,
    
    file_path TEXT NOT NULL,
    language TEXT,
    change_type TEXT,  -- 'added', 'modified', 'deleted', 'renamed'
    
    lines_added INTEGER,
    lines_deleted INTEGER,
    complexity_score REAL,
    
    issues_detected TEXT[],
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_mr_files_mr_id ON mr_files(mr_id);
CREATE INDEX idx_mr_files_language ON mr_files(language);
```

### Таблица: `mr_comments` (комментарии из оригинального ревью)

```sql
CREATE TABLE mr_comments (
    id SERIAL PRIMARY KEY,
    mr_id INTEGER REFERENCES merge_requests(id) ON DELETE CASCADE,
    
    author TEXT,
    file_path TEXT,
    line_number INTEGER,
    comment_text TEXT,
    comment_type TEXT,  -- 'suggestion', 'question', 'issue', 'approval'
    
    created_at TIMESTAMP,
    created_at_db TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_mr_comments_mr_id ON mr_comments(mr_id);
CREATE INDEX idx_mr_comments_file ON mr_comments(file_path);
```

### Таблица: `mr_metrics` (дополнительные метрики)

```sql
CREATE TABLE mr_metrics (
    id SERIAL PRIMARY KEY,
    mr_id INTEGER REFERENCES merge_requests(id) ON DELETE CASCADE,
    
    metric_name TEXT NOT NULL,
    metric_value REAL,
    metric_data JSONB,  -- Дополнительные данные метрики
    
    calculated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(mr_id, metric_name)
);

CREATE INDEX idx_mr_metrics_mr_id ON mr_metrics(mr_id);
CREATE INDEX idx_mr_metrics_name ON mr_metrics(metric_name);
```

---

## 4. План заполнения базы данных

### Источники данных:

1. **GitHub Pull Requests**
   - Использовать GitHub API
   - Импорт популярных open-source проектов
   - Фильтрация по метрикам

2. **GitLab Merge Requests**
   - GitLab API
   - Аналогично GitHub

3. **Локальные репозитории**
   - Анализ локальных git репозиториев
   - Генерация diff из истории коммитов

### Процесс импорта:

1. **Сбор MR** (скрипт `scripts/collect_mrs.py`)
   - Поиск MR по критериям
   - Фильтрация по метрикам
   - Сохранение в промежуточный формат

2. **Анализ MR** (скрипт `scripts/analyze_mrs.py`)
   - Вычисление метрик
   - Определение сложности
   - Классификация проблем

3. **Импорт в БД** (скрипт `scripts/import_mrs.py`)
   - Загрузка в PostgreSQL
   - Валидация данных
   - Создание индексов

---

## 5. Обновление архитектуры

### Изменения в API:

#### Новые endpoints:

```
GET  /api/mr/list              - Список MR с фильтрацией
GET  /api/mr/{id}              - Детали MR
GET  /api/mr/{id}/diff          - Получить diff
GET  /api/mr/{id}/files        - Список файлов в MR
GET  /api/mr/{id}/comments     - Комментарии из оригинального ревью
POST /api/mr/{id}/analyze      - Пересчитать метрики
```

#### Интеграция с сессиями:

```
POST /api/reviewer/sessions
  {
    ...existing fields,
    "mr_id": 123  // Новое поле - привязка к MR
  }
```

### Изменения в модели данных:

- Добавить поле `mr_id` в таблицу `sessions`
- Связь: `sessions.mr_id -> merge_requests.id`

### Изменения в UI:

- Выбор MR при создании сессии
- Отображение информации о MR в сессии
- Фильтры по метрикам MR

---

## Следующие шаги

1. ✅ Создать план (этот документ)
2. ⏳ Настроить PostgreSQL в Docker Compose
3. ⏳ Создать миграции для таблиц MR
4. ⏳ Разработать скрипты сбора и анализа MR
5. ⏳ Реализовать API endpoints для MR
6. ⏳ Интегрировать MR в процесс создания сессий
7. ⏳ Обновить UI для работы с MR

