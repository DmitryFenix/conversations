# Покрытие тестами

## Метод тестирования: Чёрный ящик (Black Box)

Тесты проверяют функциональность API через HTTP endpoints **без знания внутренней реализации**. Это означает:
- ✅ Тесты независимы от внутренней структуры кода
- ✅ Тесты проверяют реальное поведение системы
- ✅ Тесты можно запускать против любого API, реализующего те же endpoints

## Покрытие функциональности

### ✅ Создание и управление сессиями
- [x] Создание сессии ревьюером
- [x] Валидация входных данных
- [x] Получение списка сессий
- [x] Получение конкретной сессии
- [x] Получение сессии кандидатом по токену
- [x] Защита от невалидных токенов

### ✅ Работа с комментариями
- [x] Добавление комментария кандидатом
- [x] Получение списка комментариев
- [x] Видимость комментариев для ревьюера
- [x] Структура комментариев (file, line_range, type, severity, text)

### ✅ Интеграция с Gitea
- [x] Проверка наличия информации о Gitea в сессии
- [x] Создание Pull Request
- [x] Получение информации о PR
- [x] Синхронизация комментариев из Gitea
- [x] Обработка случаев, когда Gitea не настроена

### ✅ Управление жизненным циклом сессии
- [x] Сигнал готовности кандидата
- [x] Завершение сессии ревьюером
- [x] Удаление сессии (soft delete)
- [x] Проверка, что удалённые сессии не видны в списке

### ✅ Оценка и отчёты
- [x] Запуск оценки сессии
- [x] Проверка статуса задачи оценки
- [x] Получение diff сессии
- [x] Получение отчёта (с обработкой случая, когда отчёт не готов)

## Что НЕ тестируется (намеренно)

- ❌ Внутренняя логика базы данных
- ❌ Детали реализации Gitea клиента
- ❌ Внутренняя структура Redis очередей
- ❌ Детали работы worker'ов

Эти аспекты тестируются через их влияние на API endpoints.

## Структура тестов

```
tests/
├── conftest.py              # Фикстуры (HTTP клиент, тестовые данные)
├── test_api.py              # Основные тесты, сгруппированные по классам
├── pytest.ini               # Конфигурация pytest
├── requirements.txt          # Зависимости для тестов
├── run_tests.py             # Скрипт для непрерывного запуска
├── run_tests.sh             # Bash скрипт для watch mode
├── run_tests_docker.sh      # Скрипт для запуска в Docker
├── README.md                # Документация
├── QUICKSTART.md            # Быстрый старт
└── TEST_COVERAGE.md         # Этот файл
```

## Группы тестов

1. **TestSessionCreation** - создание сессий
2. **TestSessionRetrieval** - получение сессий
3. **TestComments** - работа с комментариями
4. **TestGiteaIntegration** - интеграция с Gitea
5. **TestSessionManagement** - управление сессиями
6. **TestEvaluation** - оценка сессий
7. **TestArtifacts** - работа с артефактами

## Запуск тестов

### Один раз
```bash
pytest tests/test_api.py -v
```

### Непрерывно (watch mode)
```bash
python tests/run_tests.py
```

### С фильтрацией
```bash
# Только тесты создания сессий
pytest tests/test_api.py::TestSessionCreation -v

# Только тесты Gitea
pytest tests/test_api.py::TestGiteaIntegration -v
```

## Примечания

- Тесты создают реальные данные в базе данных
- Тесты выполняются последовательно и могут зависеть друг от друга
- Некоторые тесты могут быть пропущены, если условия не выполнены (например, Gitea не настроена)
- Тесты используют реальный API, поэтому сервер должен быть запущен

